services:
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    restart: always
    ports:
      - "1883:1883"   # MQTT (TCP)
      - "9001:9001"   # MQTT over WebSockets
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - iot-parking-network
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -W 1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  mongodb:
    image: mongo:6.0
    container_name: mongodb
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - ./mongo/data:/data/db
      - ./mongo/config:/data/configdb
    networks:
      - iot-parking-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: iot-parking-backend
    restart: unless-stopped
    environment:
      # ASP.NET Core configuration
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      
      # MongoDB configuration
      MongoDbSettings__ConnectionString: mongodb://admin:password@mongodb:27017
      MongoDbSettings__DatabaseName: iot_parking
      MongoDbSettings__SensorReadingsCollectionName: sensor_readings
      
      # MQTT configuration
      MqttSettings__BrokerHost: mosquitto
      MqttSettings__BrokerPort: 1883
      MqttSettings__ClientId: iot-parking-backend
      MqttSettings__Topic: parking/sensor/#
      MqttSettings__UseTls: false

      Blockchain__RpcUrl: http://blockchain:8545
      
    depends_on:
      mongodb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
      blockchain:
        condition: service_started
    networks:
      - iot-parking-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: iot-parking-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - iot-parking-network

  sensors:
    container_name: sensors
    build:
      context: ./sensors 
      dockerfile: Dockerfile
    depends_on:
      - mosquitto
    environment:
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883
    tty: true        
    stdin_open: true
    networks:
      - iot-parking-network

  blockchain:
    build: ./blockchain
    container_name: iot-parking-blockchain
    ports:
      - "8545:8545"
    networks:
      - iot-parking-network

networks:
  iot-parking-network:
    driver: bridge